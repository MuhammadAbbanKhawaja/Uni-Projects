
#include <iostream>
#include <iomanip>
#include <string>
using namespace std;

// Global variables
char board[24];
int currentPlayer = 1;
int playerPieces[2] = { 9, 9 };   // Pieces left to place
int placedPieces[2] = { 0, 0 };   // Pieces currently on the board

// Predefined mill combinations
int mills[16][3] = { // row wise..
    {0, 1, 2}, {3, 4, 5}, {6, 7, 8}, {9, 10, 11},
    {12, 13, 14}, {15, 16, 17}, {18,19,20},{21,22,23}, /*colonm wise */ {0, 9, 21}, {1, 4, 7},
    {3, 10, 18}, {6, 11, 15}, {8, 12, 17}, {5, 13, 20},
    {16,19,22} ,{2, 14, 23}
};

// Function to initialize the board
void initializeBoard()
{
    for (int i = 0; i < 24; i++)
    {
        board[i] = ' ';
    }
}

// Function to display the board
void displayBoard()
{
    system("cls");
    cout << endl;
    cout << "           " << board[0] << " ----------- " << board[1] << " ----------- " << board[2] << "\n";   // 1st row
    cout << "           |             |             |\n";
    cout << "           |     " << board[3] << " ----- " << board[4] << " ----- " << board[5] << "     |\n";   // 2nd row
    cout << "           |     |       |       |     |\n";
    cout << "           |     |   " << board[6] << "-- " << board[7] << " -- " << board[8] << "  |     |\n";   // 3rd row
    cout << "           |     |   |        |  |     |\n";
    cout << "           " << board[9] << " --- " << board[10] << "---" << board[11] << "        "              // 4.1 (left) row
        << board[12] << "--" << board[13] << "---- " << board[14] << "\n";                                    // 4.2 (right) row
    cout << "           |     |   |        |  |     |\n";
    cout << "           |     |   " << board[15] << "---" << board[16] << "---" << board[17] << "   |     |\n"; // 5th row
    cout << "           |     |       |       |     |\n";
    cout << "           |     " << board[18] << " ----- " << board[19] << " ----- " << board[20] << "     |\n"; // 6th row
    cout << "           |             |             |\n";
    cout << "           " << board[21] << " ----------- " << board[22] << " ----------- " << board[23] << "\n"; // 7th / final row
    cout << endl;
}

// Function to switch the current player
void switchPlayer()
{
    currentPlayer = (currentPlayer == 1) ? 2 : 1;
}

// Function to check if a mill is formed
bool checkMill(int pos)
{
    char playerChar = (currentPlayer == 1) ? 'X' : 'O';
    for (int i = 0; i < 16; i++)
    {
        if ((mills[i][0] == pos || mills[i][1] == pos || mills[i][2] == pos) &&
            board[mills[i][0]] == playerChar &&
            board[mills[i][1]] == playerChar &&
            board[mills[i][2]] == playerChar) {
            return true;
        }
    }
    return false;
}

// Function to check if a piece is part of a mill
bool isPartOfMill(int pos, char opponentChar) {
    for (int i = 0; i < 16; i++) {
        if (board[mills[i][0]] == opponentChar &&
            board[mills[i][1]] == opponentChar &&
            board[mills[i][2]] == opponentChar) {
            if (mills[i][0] == pos || mills[i][1] == pos || mills[i][2] == pos) {
                return true;
            }
        }
    }
    return false;
}

int adjacencyList[24][4] = {
    {1, 9, -1, -1},    // 0: Row - Right (1), Column - Down (9)
    {0, 2, 4, -1},     // 1: Row - Left (0), Right (2), Column - Down (4)
    {1, 14, -1, -1},   // 2: Row - Left (1), Column - Down (14)
    {4, 10, -1, -1},   // 3: Row - Right (4), Column - Down (10)
    {1, 3, 5, 7},      // 4: Row - Left (3), Right (5), Column - Up (1), Down (7)
    {4, 13, -1, -1},   // 5: Row - Left (4), Column - Down (13)
    {7, 11, -1, -1},   // 6: Row - Right (7), Column - Down (11)
    {4, 6, 8, -1},     // 7: Row - Left (6), Right (8), Column - Up (4), Down (8)
    {7, 12, -1, -1},   // 8: Row - Left (7), Column - Down (12)
    {0, 10, 21, -1},   // 9: Row - Right (10), Column - Down (21), Up (0)
    {3, 9, 11, 18},    // 10: Row - Left (9), Right (11), Column - Up (3), Down (18)
    {6, 10, 15, -1},   // 11: Row - Left (10), Column - Up (6), Down (15)
    {8, 13, 17, -1},   // 12: Row - Left (13), Column - Up (8), Down (17)
    {5, 12, 14, 20},   // 13: Row - Left (12), Right (14), Column - Up (5), Down (20)
    {2, 13, 23, -1},   // 14: Row - Left (13), Column - Up (2), Down (23)
    {11, 16, -1, -1},  // 15: Row - Right (16), Column - Up (11)
    {15, 17, 19, -1},  // 16: Row - Left (15), Right (17), Column - Down (19)
    {12, 16, -1, -1},  // 17: Row - Left (16), Column - Up (12), Down (20)
    {10, 19, -1, -1},  // 18: Row - Right (19), Column - Up (10)
    {16, 18, 20, 22},  // 19: Row - Left (18), Right (20), Column - Up (16), Down (22)
    {13, 19, -1, -1},  // 20: Row - Left (17), Column - Up (13), Down (23)
    {9, 22, -1, -1},   // 21: Column - Up (9), Down (22)
    {19, 21, 23, -1},  // 22: Row - Left (21), Right (23), Column - Up (19)
    {14, 22, -1, -1},  // 23: Row - Left (20), Column - Up (14), Down (22)
};



// Function to remove an opponent's piece
void removeOpponentPiece()
{
    int pos;
    char opponentChar = (currentPlayer == 1) ? 'O' : 'X';
    while (true) {
        cout << "Enter the position of the opponent's piece to remove (0-23): ";
        cin >> pos;
        if (pos < 0 || pos >= 24 || board[pos] != opponentChar)
        {
            cout << "Invalid position! Try again." << endl;
        }
        else if (isPartOfMill(pos, opponentChar))
        {
            bool allInMills = true;
            for (int i = 0; i < 24; i++)
            {
                if (board[i] == opponentChar && !isPartOfMill(i, opponentChar))
                {
                    allInMills = false;
                    break;
                }
            }
            if (allInMills)
            {
                board[pos] = ' ';
                placedPieces[(currentPlayer == 1) ? 1 : 0]--;
                break;
            }
            else {
                cout << "Cannot remove a piece that's part of a mill! Try again." << endl;
            }
        }
        else {
            board[pos] = ' ';
            placedPieces[(currentPlayer == 1) ? 1 : 0]--;
            break;
        }
    }
    displayBoard();
}

// Function for the placement phase
void placePiece()
{
    int pos;
    while (true)
    {
        cout << "Player " << currentPlayer << " (" << ((currentPlayer == 1) ? 'X' : 'O') << "), enter position to place your piece (0-23): ";
        cin >> pos;
        if (pos < 0 || pos >= 24 || board[pos] != ' ')
        {
            cout << "Invalid position! Try again." << endl;
        }
        else {
            break;
        }
    }
    board[pos] = (currentPlayer == 1) ? 'X' : 'O';
    playerPieces[currentPlayer - 1]--;
    placedPieces[currentPlayer - 1]++;
    displayBoard();
    if (checkMill(pos))
    {
        cout << "Player " << currentPlayer << " formed a mill! Remove an opponent's piece.\n";
        removeOpponentPiece();
    }
    switchPlayer();
}

// Function to check if a piece has any valid moves
bool hasValidMoves(int currentPos) {
    for (int i = 0; i < 4 && adjacencyList[currentPos][i] != -1; i++) {
        int adjacentPos = adjacencyList[currentPos][i];
        if (board[adjacentPos] == ' ') {
            return true; // Found at least one valid move
        }
    }
    return false; // No valid moves
}

// Function to move a piece
void movePiece() {
    int currentPos, destinationPos;
    while (true) {
        // Ask for the piece to move
        cout << "Player " << currentPlayer << " (" << ((currentPlayer == 1) ? 'X' : 'O') << "), enter the position of the piece to move (0-23): ";
        cin >> currentPos;

        // Validate the source position
        if (currentPos < 0 || currentPos >= 24 || board[currentPos] != ((currentPlayer == 1) ? 'X' : 'O')) 
        {
            cout << "Invalid source position! Try again." << endl;
            continue;
        }

        // Check if the piece has valid moves
        if (!hasValidMoves(currentPos)) {
            cout << "This piece has no valid moves! Try another piece." << endl;
            continue;
        }

        // Ask for the destination position
        cout << "Enter the destination position (0-23): ";
        cin >> destinationPos;

        // Validate the destination position
        if (destinationPos < 0 || destinationPos >= 24 || board[destinationPos] != ' ') 
        {
            cout << "Invalid destination! Try again." << endl;
            continue;
        }

        // Validate adjacency for straight rows and columns
        bool isAdjacent = false;
        for (int i = 0; i < 4 && adjacencyList[currentPos][i] != -1; i++) 
        {
            if (adjacencyList[currentPos][i] == destinationPos)
            {
                isAdjacent = true;
                break;
            }
        }

        // If not adjacent, prompt the player to try again
        if (!isAdjacent) {
            cout << "The destination is not Valid! Try again." << endl;
            continue;
        }

        // Perform the move
        board[destinationPos] = board[currentPos];
        board[currentPos] = ' ';
        displayBoard();

        // Check if a mill is formed
        if (checkMill(destinationPos)) {
            cout << "Player " << currentPlayer << " formed a mill! Remove an opponent's piece." << endl;
            removeOpponentPiece();
        }

        // Switch to the other player
        switchPlayer();
        break;
    }
}


// Function to check if the game is over
bool isGameOver()
{
    return placedPieces[0] < 3 || placedPieces[1] < 3;
}

// Main function to execute the game
void startGame() {
    initializeBoard();
    displayBoard();

    while (playerPieces[0] > 0 || playerPieces[1] > 0)
    {
        placePiece();
    }

    while (!isGameOver()) {
        movePiece();
    }

    cout << "Game Over! Player " << ((placedPieces[0] < 3) ? 2 : 1) << " has won!" << endl;
}

int main()
{
    startGame();
    return 0;
}